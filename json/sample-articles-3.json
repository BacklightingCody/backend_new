{
  "articles": [
    {
      "slug": "docker-postgresql-devops",
      "title": "Docker + PostgreSQL ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®è·µ",
      "summary": "æ·±å…¥æ¢è®¨å¦‚ä½•ä½¿ç”¨Dockerå®¹å™¨åŒ–PostgreSQLæ•°æ®åº“ï¼ŒåŒ…å«é«˜å¯ç”¨æ€§é…ç½®ã€ç›‘æ§å‘Šè­¦ã€å¤‡ä»½æ¢å¤ç­‰ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆã€‚",
      "content": "# Docker + PostgreSQL ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®è·µ\n\n![Docker PostgreSQL](https://images.unsplash.com/photo-1605745341112-85968b19335a?w=800&h=400)\n\n## æ¦‚è¿°\n\nåœ¨ç°ä»£åº”ç”¨æ¶æ„ä¸­ï¼Œ**Docker** å®¹å™¨åŒ–å’Œ **PostgreSQL** æ•°æ®åº“çš„ç»„åˆå·²æˆä¸ºä¼ä¸šçº§åº”ç”¨çš„æ ‡å‡†é…ç½®ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²å’Œç®¡ç†è¿™å¥—æŠ€æœ¯æ ˆã€‚\n\n### æ ¸å¿ƒä¼˜åŠ¿\n\n- ğŸ³ **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šç¯å¢ƒä¸€è‡´æ€§\n- ğŸ”§ **æ˜“äºç®¡ç†**ï¼šç‰ˆæœ¬æ§åˆ¶å’Œå›æ»š\n- ğŸ“ˆ **å¯æ‰©å±•æ€§**ï¼šæ°´å¹³å’Œå‚ç›´æ‰©å±•\n- ğŸ›¡ï¸ **å®‰å…¨æ€§**ï¼šéš”ç¦»å’Œæƒé™æ§åˆ¶\n- ğŸ“Š **ç›‘æ§å®Œå–„**ï¼šå®æ—¶æ€§èƒ½ç›‘æ§\n\n## ç¯å¢ƒå‡†å¤‡\n\n### ç³»ç»Ÿè¦æ±‚\n\n| ç»„ä»¶ | æœ€ä½é…ç½® | æ¨èé…ç½® | è¯´æ˜ |\n|------|----------|----------|------|\n| CPU | 2æ ¸ | 4æ ¸+ | æ•°æ®åº“è®¡ç®—å¯†é›† |\n| å†…å­˜ | 4GB | 8GB+ | PostgreSQLç¼“å­˜ |\n| å­˜å‚¨ | 50GB SSD | 100GB+ NVMe | é«˜IOPSéœ€æ±‚ |\n| ç½‘ç»œ | 1Gbps | 10Gbps | æ•°æ®ä¼ è¾“ |\n\n### åŸºç¡€ç¯å¢ƒæ­å»º\n\n```bash\n# å®‰è£…Docker\ncurl -fsSL https://get.docker.com -o get-docker.sh\nsudo sh get-docker.sh\n\n# å®‰è£…Docker Compose\nsudo apt update\nsudo apt install docker-compose-plugin\n\n# éªŒè¯å®‰è£…\ndocker --version\ndocker compose version\n```\n\n## PostgreSQLå®¹å™¨é…ç½®\n\n### åŸºç¡€é…ç½®\n\n```yaml\n# docker-compose.yml\nversion: '3.8'\n\nservices:\n  postgres:\n    image: postgres:15-alpine\n    container_name: blog_postgres\n    restart: unless-stopped\n    \n    environment:\n      POSTGRES_DB: blog_db\n      POSTGRES_USER: blog_user\n      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}\n      PGDATA: /var/lib/postgresql/data/pgdata\n    \n    volumes:\n      - postgres_data:/var/lib/postgresql/data\n      - ./config/postgresql.conf:/etc/postgresql/postgresql.conf\n      - ./init:/docker-entrypoint-initdb.d/\n    \n    ports:\n      - \"5432:5432\"\n    \n    networks:\n      - blog_network\n    \n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U blog_user -d blog_db\"]\n      interval: 30s\n      timeout: 10s\n      retries: 5\n      start_period: 30s\n\nvolumes:\n  postgres_data:\n    driver: local\n\nnetworks:\n  blog_network:\n    driver: bridge\n```\n\n### æ€§èƒ½ä¼˜åŒ–é…ç½®\n\n```conf\n# config/postgresql.conf\n# å†…å­˜é…ç½®\nshared_buffers = 256MB                # 25% of RAM\neffective_cache_size = 1GB            # 75% of RAM\nwork_mem = 4MB                        # æŸ¥è¯¢å·¥ä½œå†…å­˜\nmaintenance_work_mem = 64MB           # ç»´æŠ¤æ“ä½œå†…å­˜\n\n# è¿æ¥é…ç½®\nmax_connections = 100                 # æœ€å¤§è¿æ¥æ•°\nsuperuser_reserved_connections = 3    # è¶…çº§ç”¨æˆ·ä¿ç•™è¿æ¥\n\n# å†™å…¥æ€§èƒ½\nwal_buffers = 16MB                    # WALç¼“å†²åŒº\ncheckpoint_completion_target = 0.9    # æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡\ncheckpoint_timeout = 10min            # æ£€æŸ¥ç‚¹è¶…æ—¶\n\n# æ—¥å¿—é…ç½®\nlogging_collector = on\nlog_directory = 'log'\nlog_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'\nlog_statement = 'mod'                 # è®°å½•ä¿®æ”¹è¯­å¥\nlog_duration = on                     # è®°å½•æ‰§è¡Œæ—¶é—´\nlog_min_duration_statement = 1000     # è®°å½•æ…¢æŸ¥è¯¢(1ç§’)\n\n# ç»Ÿè®¡é…ç½®\ntrack_activities = on\ntrack_counts = on\ntrack_io_timing = on\ntrack_functions = all\n```\n\n## é«˜å¯ç”¨é…ç½®\n\n### ä¸»ä»å¤åˆ¶\n\n```yaml\n# docker-compose.ha.yml\nversion: '3.8'\n\nservices:\n  postgres-primary:\n    image: postgres:15-alpine\n    container_name: postgres_primary\n    environment:\n      POSTGRES_DB: blog_db\n      POSTGRES_USER: blog_user\n      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}\n      POSTGRES_REPLICATION_USER: replicator\n      POSTGRES_REPLICATION_PASSWORD: ${REPLICATION_PASSWORD}\n    \n    volumes:\n      - primary_data:/var/lib/postgresql/data\n      - ./config/primary.conf:/etc/postgresql/postgresql.conf\n      - ./scripts/setup-primary.sh:/docker-entrypoint-initdb.d/setup-primary.sh\n    \n    ports:\n      - \"5432:5432\"\n    \n    networks:\n      - postgres_cluster\n\n  postgres-replica:\n    image: postgres:15-alpine\n    container_name: postgres_replica\n    environment:\n      POSTGRES_PRIMARY_HOST: postgres-primary\n      POSTGRES_REPLICATION_USER: replicator\n      POSTGRES_REPLICATION_PASSWORD: ${REPLICATION_PASSWORD}\n    \n    volumes:\n      - replica_data:/var/lib/postgresql/data\n      - ./scripts/setup-replica.sh:/docker-entrypoint-initdb.d/setup-replica.sh\n    \n    ports:\n      - \"5433:5432\"\n    \n    depends_on:\n      - postgres-primary\n    \n    networks:\n      - postgres_cluster\n\nvolumes:\n  primary_data:\n  replica_data:\n\nnetworks:\n  postgres_cluster:\n    driver: bridge\n```\n\n### ä¸»åº“é…ç½®è„šæœ¬\n\n```bash\n#!/bin/bash\n# scripts/setup-primary.sh\n\n# é…ç½®å¤åˆ¶ç”¨æˆ·\npsql -v ON_ERROR_STOP=1 --username \"$POSTGRES_USER\" --dbname \"$POSTGRES_DB\" <<-EOSQL\n    CREATE USER replicator WITH REPLICATION ENCRYPTED PASSWORD '$POSTGRES_REPLICATION_PASSWORD';\n    SELECT pg_create_physical_replication_slot('replica_slot');\nEOSQL\n\n# é…ç½®pg_hba.conf\necho \"host replication replicator 0.0.0.0/0 md5\" >> \"$PGDATA/pg_hba.conf\"\n\n# é‡æ–°åŠ è½½é…ç½®\npsql -v ON_ERROR_STOP=1 --username \"$POSTGRES_USER\" --dbname \"$POSTGRES_DB\" <<-EOSQL\n    SELECT pg_reload_conf();\nEOSQL\n```\n\n## å¤‡ä»½ç­–ç•¥\n\n### è‡ªåŠ¨å¤‡ä»½è„šæœ¬\n\n```bash\n#!/bin/bash\n# scripts/backup.sh\n\nset -e\n\n# é…ç½®å˜é‡\nBACKUP_DIR=\"/backups/postgresql\"\nDATE=$(date +\"%Y%m%d_%H%M%S\")\nRETENTION_DAYS=7\nDATABASE=\"blog_db\"\nUSER=\"blog_user\"\n\n# åˆ›å»ºå¤‡ä»½ç›®å½•\nmkdir -p $BACKUP_DIR\n\n# æ‰§è¡Œå¤‡ä»½\necho \"Starting backup at $(date)\"\n\ndocker exec blog_postgres pg_dump \\\n  -U $USER \\\n  -d $DATABASE \\\n  -f /tmp/backup_$DATE.sql\n\n# å¤åˆ¶å¤‡ä»½æ–‡ä»¶\ndocker cp blog_postgres:/tmp/backup_$DATE.sql $BACKUP_DIR/\n\n# å‹ç¼©å¤‡ä»½\ngzip $BACKUP_DIR/backup_$DATE.sql\n\n# æ¸…ç†æ—§å¤‡ä»½\nfind $BACKUP_DIR -name \"backup_*.sql.gz\" -mtime +$RETENTION_DAYS -delete\n\necho \"Backup completed: backup_$DATE.sql.gz\"\n\n# éªŒè¯å¤‡ä»½\nif [ -f \"$BACKUP_DIR/backup_$DATE.sql.gz\" ]; then\n    echo \"Backup verification: SUCCESS\"\nelse\n    echo \"Backup verification: FAILED\"\n    exit 1\nfi\n```\n\n### å®šæ—¶å¤‡ä»½é…ç½®\n\n```bash\n# æ·»åŠ åˆ°crontab\n# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå¤‡ä»½\n0 2 * * * /opt/scripts/backup.sh >> /var/log/postgres-backup.log 2>&1\n\n# æ¯å‘¨æ—¥æ‰§è¡Œå®Œæ•´å¤‡ä»½\n0 1 * * 0 /opt/scripts/full-backup.sh >> /var/log/postgres-backup.log 2>&1\n```\n\n## ç›‘æ§å’Œå‘Šè­¦\n\n### Prometheusç›‘æ§é…ç½®\n\n```yaml\n# monitoring/docker-compose.yml\nversion: '3.8'\n\nservices:\n  postgres-exporter:\n    image: prometheuscommunity/postgres-exporter\n    container_name: postgres_exporter\n    environment:\n      DATA_SOURCE_NAME: \"postgresql://blog_user:${POSTGRES_PASSWORD}@postgres:5432/blog_db?sslmode=disable\"\n    \n    ports:\n      - \"9187:9187\"\n    \n    networks:\n      - monitoring\n      - blog_network\n    \n    depends_on:\n      - postgres\n\n  prometheus:\n    image: prom/prometheus\n    container_name: prometheus\n    ports:\n      - \"9090:9090\"\n    \n    volumes:\n      - ./prometheus.yml:/etc/prometheus/prometheus.yml\n      - prometheus_data:/prometheus\n    \n    networks:\n      - monitoring\n\n  grafana:\n    image: grafana/grafana\n    container_name: grafana\n    ports:\n      - \"3000:3000\"\n    \n    environment:\n      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}\n    \n    volumes:\n      - grafana_data:/var/lib/grafana\n      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards\n    \n    networks:\n      - monitoring\n\nvolumes:\n  prometheus_data:\n  grafana_data:\n\nnetworks:\n  monitoring:\n    driver: bridge\n  blog_network:\n    external: true\n```\n\n### å…³é”®æŒ‡æ ‡ç›‘æ§\n\n```yaml\n# prometheus.yml\nglobal:\n  scrape_interval: 15s\n\nscrape_configs:\n  - job_name: 'postgres'\n    static_configs:\n      - targets: ['postgres-exporter:9187']\n    scrape_interval: 30s\n    metrics_path: /metrics\n```\n\n## æ€§èƒ½ä¼˜åŒ–\n\n### è¿æ¥æ± é…ç½®\n\n```yaml\n# æ·»åŠ PgBouncerè¿æ¥æ± \nservices:\n  pgbouncer:\n    image: pgbouncer/pgbouncer:latest\n    container_name: pgbouncer\n    environment:\n      DATABASES_HOST: postgres\n      DATABASES_PORT: 5432\n      DATABASES_USER: blog_user\n      DATABASES_PASSWORD: ${POSTGRES_PASSWORD}\n      DATABASES_DBNAME: blog_db\n      POOL_MODE: transaction\n      SERVER_RESET_QUERY: DISCARD ALL\n      MAX_CLIENT_CONN: 100\n      DEFAULT_POOL_SIZE: 20\n    \n    ports:\n      - \"6432:5432\"\n    \n    depends_on:\n      - postgres\n    \n    networks:\n      - blog_network\n```\n\n### æŸ¥è¯¢ä¼˜åŒ–\n\n```sql\n-- æ€§èƒ½åˆ†ææŸ¥è¯¢\n-- æŸ¥çœ‹æ…¢æŸ¥è¯¢\nSELECT \n  query,\n  calls,\n  total_time,\n  mean_time,\n  rows\nFROM pg_stat_statements \nORDER BY total_time DESC \nLIMIT 10;\n\n-- æŸ¥çœ‹è¡¨å¤§å°\nSELECT \n  schemaname,\n  tablename,\n  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size\nFROM pg_tables \nWHERE schemaname = 'public'\nORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;\n\n-- åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯\nANALYZE;\n\n-- é‡å»ºç´¢å¼•\nREINDEX INDEX CONCURRENTLY idx_articles_created_at;\n```\n\n## å®‰å…¨é…ç½®\n\n### SSL/TLSé…ç½®\n\n```bash\n# ç”ŸæˆSSLè¯ä¹¦\nopenssl req -new -x509 -days 365 -nodes -text \\\n  -out server.crt \\\n  -keyout server.key \\\n  -subj \"/CN=postgres.example.com\"\n\nchmod 600 server.key\nchown postgres:postgres server.crt server.key\n```\n\n```conf\n# postgresql.conf SSLé…ç½®\nssl = on\nssl_cert_file = 'server.crt'\nssl_key_file = 'server.key'\nssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'\nssl_prefer_server_ciphers = on\n```\n\n### è®¿é—®æ§åˆ¶\n\n```conf\n# pg_hba.conf\n# TYPE  DATABASE        USER            ADDRESS                 METHOD\n\n# æœ¬åœ°è¿æ¥\nlocal   all             postgres                                peer\nlocal   all             all                                     md5\n\n# IPv4è¿æ¥\nhost    all             all             127.0.0.1/32            md5\nhost    blog_db         blog_user       10.0.0.0/8              md5\n\n# SSLè¿æ¥\nhostssl all             all             0.0.0.0/0               md5\n```\n\n## æ•…éšœæ’é™¤\n\n### å¸¸è§é—®é¢˜è¯Šæ–­\n\n```bash\n# æ£€æŸ¥å®¹å™¨çŠ¶æ€\ndocker ps -a\ndocker logs blog_postgres\n\n# æ£€æŸ¥æ•°æ®åº“è¿æ¥\ndocker exec -it blog_postgres psql -U blog_user -d blog_db\n\n# æ£€æŸ¥ç£ç›˜ç©ºé—´\ndf -h\ndocker system df\n\n# æ£€æŸ¥å†…å­˜ä½¿ç”¨\nfree -h\ndocker stats blog_postgres\n\n# æ£€æŸ¥ç½‘ç»œè¿æ¥\nnetstat -tlnp | grep 5432\ndocker network ls\n```\n\n### æ€§èƒ½è°ƒä¼˜å‘½ä»¤\n\n```sql\n-- æ£€æŸ¥è¿æ¥æ•°\nSELECT count(*) FROM pg_stat_activity;\n\n-- æ£€æŸ¥é”ç­‰å¾…\nSELECT * FROM pg_stat_activity WHERE waiting = true;\n\n-- æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡\nSELECT \n  sum(heap_blks_read) as heap_read,\n  sum(heap_blks_hit) as heap_hit,\n  sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)) as ratio\nFROM pg_statio_user_tables;\n```\n\n## éƒ¨ç½²è‡ªåŠ¨åŒ–\n\n### Ansibleéƒ¨ç½²è„šæœ¬\n\n```yaml\n# deploy.yml\n---\n- hosts: database_servers\n  become: yes\n  vars:\n    postgres_version: \"15\"\n    postgres_password: \"{{ vault_postgres_password }}\"\n  \n  tasks:\n    - name: Install Docker\n      apt:\n        name: docker.io\n        state: present\n        update_cache: yes\n    \n    - name: Create PostgreSQL directory\n      file:\n        path: /opt/postgresql\n        state: directory\n        mode: '0755'\n    \n    - name: Copy docker-compose file\n      template:\n        src: docker-compose.yml.j2\n        dest: /opt/postgresql/docker-compose.yml\n    \n    - name: Start PostgreSQL container\n      docker_compose:\n        project_src: /opt/postgresql\n        state: present\n```\n\n## æ€»ç»“\n\næœ¬æ–‡è¯¦ç»†ä»‹ç»äº†Docker + PostgreSQLåœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„å®Œæ•´éƒ¨ç½²æ–¹æ¡ˆï¼š\n\n- âœ… **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šDocker Composeé…ç½®\n- âœ… **é«˜å¯ç”¨æ¶æ„**ï¼šä¸»ä»å¤åˆ¶é…ç½®\n- âœ… **å¤‡ä»½ç­–ç•¥**ï¼šè‡ªåŠ¨åŒ–å¤‡ä»½å’Œæ¢å¤\n- âœ… **ç›‘æ§å‘Šè­¦**ï¼šPrometheus + Grafana\n- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šè¿æ¥æ± å’ŒæŸ¥è¯¢ä¼˜åŒ–\n- âœ… **å®‰å…¨é…ç½®**ï¼šSSLå’Œè®¿é—®æ§åˆ¶\n\n### æœ€ä½³å®è·µæ€»ç»“\n\n1. **èµ„æºè§„åˆ’**ï¼šåˆç†é…ç½®CPUã€å†…å­˜å’Œå­˜å‚¨\n2. **å¤‡ä»½ç­–ç•¥**ï¼šå®šæœŸå¤‡ä»½å’Œæµ‹è¯•æ¢å¤\n3. **ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡\n4. **å®‰å…¨åŠ å›º**ï¼šSSLåŠ å¯†å’Œè®¿é—®æ§åˆ¶\n5. **æ€§èƒ½è°ƒä¼˜**ï¼šå®šæœŸåˆ†æå’Œä¼˜åŒ–\n\n### è¿›é˜¶è¯é¢˜\n\n- **åˆ†åº“åˆ†è¡¨**ï¼šå¤§æ•°æ®é‡å¤„ç†\n- **è¯»å†™åˆ†ç¦»**ï¼šæå‡æŸ¥è¯¢æ€§èƒ½\n- **å®¹å™¨ç¼–æ’**ï¼šKuberneteséƒ¨ç½²\n- **ç¾å¤‡æ–¹æ¡ˆ**ï¼šè·¨åœ°åŸŸå¤‡ä»½\n\n---\n\n**ç›¸å…³èµ„æº**ï¼š\n- ğŸ“– [PostgreSQLå®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/)\n- ğŸ“– [Dockerå®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)\n- ğŸ”§ [é…ç½®æ–‡ä»¶ç¤ºä¾‹](https://github.com/example/postgres-docker)\n- ğŸ“Š [Grafanaä»ªè¡¨ç›˜](https://grafana.com/grafana/dashboards/)\n\n*å¸Œæœ›è¿™ä»½å®è·µæŒ‡å—èƒ½å¸®åŠ©ä½ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æˆåŠŸéƒ¨ç½²PostgreSQLï¼*",
      "coverImage": "https://images.unsplash.com/photo-1605745341112-85968b19335a?w=1200&h=600",
      "readTime": 18,
      "tags": [
        "NestJS",
        "Prisma",
        "TypeScript",
        "Node.js",
        "Webå¼€å‘"
      ],
      "category": "DevOps",
      "isPublished": true,
      "isDraft": false,
      "viewCount": 743,
      "likes": 65,
      "bookmarks": 41,
      "comments": 17,
      "userId": 1
    }
  ]
}